<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ë° í”¼ë“œë°± ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js CDN (ëª¨ë¸ ë¡œë”© ë° ì¶”ë¡ ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container { max-width: 90%; margin: auto; }
        .camera-container { position: relative; width: 100%; max-width: 640px; margin: 0 auto; }
        #webcam { width: 100%; height: auto; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        #overlayCanvas { position: absolute; top: 0; left: 0; }
        /* ê°ì • ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ì„¤ì • */
        .positive { background-color: #d1fae5; color: #059669; }
        .negative { background-color: #fee2e2; color: #dc2626; }
        .neutral { background-color: #e0f2fe; color: #0ea5e9; }
        .unknown { background-color: #e5e7eb; color: #6b7280; }
        .camera-active { border: 4px solid #10b981; }
        .camera-inactive { border: 4px solid #f87171; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container bg-white p-6 rounded-2xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">
            ê°ì • ê¸°ë°˜ í•™ìŠµ í”¼ë“œë°± ì‹œìŠ¤í…œ
        </h1>
        <p class="text-sm text-gray-600 mb-6 text-center">
            AI ëª¨ë¸ì„ í†µí•´ í•™ìŠµìì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  ì§„ë™/ìŒí–¥ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
        </p>

        <!-- ì¹´ë©”ë¼ ì„¤ì • ì…ë ¥ í•„ë“œ -->
        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¹´ë©”ë¼ ì†ŒìŠ¤ ì„¤ì •</label>
            <div class="flex space-x-2">
                <input type="text" id="cameraUrl" placeholder="IP ì¹´ë©”ë¼ URL (ì˜ˆ: http://192.168.1.100/stream)" 
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <button id="startStopBtn" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 text-sm font-semibold">
                    ë‚´ì¥ ì¹´ë©”ë¼ ì‹œì‘
                </button>
            </div>
            <p class="text-xs text-red-500 mt-2">
                *ì£¼ì˜: IP ì¹´ë©”ë¼ ì‚¬ìš© ì‹œ, GitHub Pages(HTTPS)ì—ì„œëŠ” ë³´ì•ˆ ë¬¸ì œë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì„œë²„(HTTP)ì—ì„œ ì‹¤í–‰í•´ ë³´ì„¸ìš”.
            </p>
        </div>

        <!-- ì¹´ë©”ë¼ ë° ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ -->
        <div class="camera-container mb-6 camera-inactive" id="videoWrapper">
            <video id="webcam" playsinline autoplay muted></video>
            <canvas id="overlayCanvas"></canvas>
        </div>

        <!-- ëª¨ë¸ ìƒíƒœ ë° ì˜ˆì¸¡ ê²°ê³¼ -->
        <div id="status" class="mb-4 p-3 rounded-lg text-center font-medium bg-blue-100 text-blue-700">
            ëª¨ë¸ ë¡œë”© ì¤‘...
        </div>

        <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">ë¶„ë¥˜ëœ ê°ì • ì¹´í…Œê³ ë¦¬</h2>
            <div id="category-prediction" class="text-3xl font-extrabold mb-3 text-center transition-colors duration-500 rounded-lg p-3 unknown">
                ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.
            </div>
            
            <h2 class="text-xl font-semibold mt-4 mb-2 text-gray-700">ë§ì¶¤ í”¼ë“œë°± ë° ì•Œë¦¼</h2>
            <div id="feedback" class="text-lg text-gray-700 p-3 border-l-4 border-indigo-400 pl-4 rounded-md bg-white shadow-sm">
                ê°ì • ë¶„ì„ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì— í”¼ë“œë°±ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="text-sm text-gray-500 mt-4 flex justify-between">
                <span id="confidence">ì‹ ë¢°ë„: N/A</span>
                <span id="fps">FPS: N/A</span>
            </div>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ ì •ì˜
        const video = document.getElementById('webcam');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const ctx = overlayCanvas.getContext('2d');
        const statusElement = document.getElementById('status');
        const categoryPredictionElement = document.getElementById('category-prediction');
        const feedbackElement = document.getElementById('feedback');
        const confidenceElement = document.getElementById('confidence');
        const fpsElement = document.getElementById('fps');
        const cameraUrlInput = document.getElementById('cameraUrl');
        const startStopBtn = document.getElementById('startStopBtn');
        const videoWrapper = document.getElementById('videoWrapper');
        
        let model = null;
        let lastTime = performance.now();
        let animationFrameId = null;
        let isCameraActive = false;
        let lastCategory = 'Unknown'; // ì§„ë™/ìŒí–¥ í”¼ë“œë°±ì„ ìœ„í•œ ìƒíƒœ ì¶”ì 

        // --- 1. 7-í´ë˜ìŠ¤ ê°ì • ë ˆì´ë¸” ì •ì˜ ---
        const EMOTIONS_7_CLASS = [
            'Angry', 'Disgust', 'Fear', 'Happy', 
            'Sad', 'Surprise', 'Neutral'
        ];
        
        // --- 2. 7-í´ë˜ìŠ¤ë¥¼ 3-ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘ ë° í”¼ë“œë°± ì •ì˜ ---
        // 0.35 ë¯¸ë§Œ ì‹ ë¢°ë„ëŠ” 'Unknown'ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ê°•ì œì ì¸ 'ì¤‘ë¦½' ë¶„ë¥˜ë¥¼ ë§‰ìŠµë‹ˆë‹¤. (0.50ì—ì„œ 0.35ë¡œ ìˆ˜ì •)
        const CONFIDENCE_THRESHOLD = 0.35; 

        const CATEGORY_MAP = {
            'Happy': { label: 'ğŸ˜Š ê¸ì • (Positive)', category: 'positive', feedback: 'ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤! ì§€ê¸ˆì²˜ëŸ¼ ê¸ì •ì ì¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©° ì§‘ì¤‘í•˜ì„¸ìš”.', color: '#10B981' },
            'Surprise': { label: 'ğŸ˜Š ê¸ì • (Positive)', category: 'positive', feedback: 'ë†€ë¼ì›€ì€ ê¸ì •ì ì¸ í¥ë¯¸ì˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìŠµì— ì—´ì¤‘í•˜ê³  ê³„ì‹œêµ°ìš”!', color: '#10B981' },
            'Neutral': { label: 'ğŸ§˜ ì¤‘ë¦½ (Neutral)', category: 'neutral', feedback: 'í¸ì•ˆí•˜ê³  ì§‘ì¤‘ëœ ìƒíƒœì…ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœê°€ í•™ìŠµì— ê°€ì¥ íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', color: '#0EA5E9' },
            'Angry': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ì ì‹œ ë©ˆì¶”ê³  ì‹¬í˜¸í¡ì„ í•˜ê±°ë‚˜ 5ë¶„ê°„ íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”. (ì•Œë¦¼: ğŸ””ğŸš¨)', color: '#DC2626' },
            'Disgust': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! í™˜ê²½ì´ë‚˜ ë‚´ìš©ì— ëŒ€í•œ ë¶ˆë§Œì¡± ì‹ í˜¸ì…ë‹ˆë‹¤. ìë¦¬ë¥¼ ë°”ê¿”ë³´ì„¸ìš”.', color: '#DC2626' },
            'Fear': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', 'category': 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ë¶ˆì•ˆê°ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤. ë„ˆë¬´ ì–´ë µë‹¤ë©´ ì‰¬ìš´ ë‚´ìš©ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ ë³´ì„¸ìš”.', color: '#DC2626' },
            'Sad': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ì ì‹œ ì‰¬ì–´ê°€ëŠ” ì‹œê°„ì„ ê°–ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?', color: '#DC2626' }
        };

        // --- 3. í”¼ë“œë°± (ì§„ë™ & ìŒí–¥) ê¸°ëŠ¥ ---
        function playNegativeFeedback() {
            // A. ì§„