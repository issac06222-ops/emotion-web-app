<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ë° í”¼ë“œë°± ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js CDN (ëª¨ë¸ ë¡œë”© ë° ì¶”ë¡ ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container { max-width: 90%; margin: auto; }
        .camera-container { position: relative; width: 100%; max-width: 640px; margin: 0 auto; }
        #webcam { width: 100%; height: auto; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        #overlayCanvas { position: absolute; top: 0; left: 0; }
        /* ê°ì • ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ì„¤ì • */
        .positive { background-color: #d1fae5; color: #059669; }
        .negative { background-color: #fee2e2; color: #dc2626; }
        .neutral { background-color: #e0f2fe; color: #0ea5e9; }
        .unknown { background-color: #e5e7eb; color: #6b7280; }
        .camera-active { border: 4px solid #10b981; }
        .camera-inactive { border: 4px solid #f87171; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container bg-white p-6 rounded-2xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">
            ê°ì • ê¸°ë°˜ í•™ìŠµ í”¼ë“œë°± ì‹œìŠ¤í…œ
        </h1>
        <p class="text-sm text-gray-600 mb-6 text-center">
            AI ëª¨ë¸ì„ í†µí•´ í•™ìŠµìì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  ì§„ë™/ìŒí–¥ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
        </p>

        <!-- ì¹´ë©”ë¼ ì„¤ì • ì…ë ¥ í•„ë“œ -->
        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-1">ì¹´ë©”ë¼ ì†ŒìŠ¤ ì„¤ì •</label>
            <div class="flex space-x-2">
                <input type="text" id="cameraUrl" placeholder="IP ì¹´ë©”ë¼ URL (ì˜ˆ: http://192.168.1.100/stream)" 
                       class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <button id="startStopBtn" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-150 text-sm font-semibold">
                    ë‚´ì¥ ì¹´ë©”ë¼ ì‹œì‘
                </button>
            </div>
            <p class="text-xs text-red-500 mt-2">
                *ì£¼ì˜: IP ì¹´ë©”ë¼ ì‚¬ìš© ì‹œ, GitHub Pages(HTTPS)ì—ì„œëŠ” ë³´ì•ˆ ë¬¸ì œë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì„œë²„(HTTP)ì—ì„œ ì‹¤í–‰í•´ ë³´ì„¸ìš”.
            </p>
        </div>

        <!-- ì¹´ë©”ë¼ ë° ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ -->
        <div class="camera-container mb-6 camera-inactive" id="videoWrapper">
            <video id="webcam" playsinline autoplay muted></video>
            <canvas id="overlayCanvas"></canvas>
        </div>

        <!-- ëª¨ë¸ ìƒíƒœ ë° ì˜ˆì¸¡ ê²°ê³¼ -->
        <div id="status" class="mb-4 p-3 rounded-lg text-center font-medium bg-blue-100 text-blue-700">
            ëª¨ë¸ ë¡œë”© ì¤‘...
        </div>

        <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">ë¶„ë¥˜ëœ ê°ì • ì¹´í…Œê³ ë¦¬</h2>
            <div id="category-prediction" class="text-3xl font-extrabold mb-3 text-center transition-colors duration-500 rounded-lg p-3 unknown">
                ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.
            </div>
            
            <h2 class="text-xl font-semibold mt-4 mb-2 text-gray-700">ë§ì¶¤ í”¼ë“œë°± ë° ì•Œë¦¼</h2>
            <div id="feedback" class="text-lg text-gray-700 p-3 border-l-4 border-indigo-400 pl-4 rounded-md bg-white shadow-sm">
                ê°ì • ë¶„ì„ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì— í”¼ë“œë°±ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="text-sm text-gray-500 mt-4 flex justify-between">
                <span id="confidence">ì‹ ë¢°ë„: N/A</span>
                <span id="fps">FPS: N/A</span>
            </div>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ ì •ì˜
        const video = document.getElementById('webcam');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const ctx = overlayCanvas.getContext('2d');
        const statusElement = document.getElementById('status');
        const categoryPredictionElement = document.getElementById('category-prediction');
        const feedbackElement = document.getElementById('feedback');
        const confidenceElement = document.getElementById('confidence');
        const fpsElement = document.getElementById('fps');
        const cameraUrlInput = document.getElementById('cameraUrl');
        const startStopBtn = document.getElementById('startStopBtn');
        const videoWrapper = document.getElementById('videoWrapper');
        
        let model = null;
        let lastTime = performance.now();
        let animationFrameId = null;
        let isCameraActive = false;
        let lastCategory = 'Unknown'; // ì§„ë™/ìŒí–¥ í”¼ë“œë°±ì„ ìœ„í•œ ìƒíƒœ ì¶”ì 

        // --- 1. 7-í´ë˜ìŠ¤ ê°ì • ë ˆì´ë¸” ì •ì˜ ---
        const EMOTIONS_7_CLASS = [
            'Angry', 'Disgust', 'Fear', 'Happy', 
            'Sad', 'Surprise', 'Neutral'
        ];
        
        // --- 2. 7-í´ë˜ìŠ¤ë¥¼ 3-ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘ ë° í”¼ë“œë°± ì •ì˜ ---
        // 0.7 ë¯¸ë§Œ ì‹ ë¢°ë„ëŠ” 'Unknown'ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ê°•ì œì ì¸ 'ì¤‘ë¦½' ë¶„ë¥˜ë¥¼ ë§‰ìŠµë‹ˆë‹¤.
        const CONFIDENCE_THRESHOLD = 0.70; 

        const CATEGORY_MAP = {
            'Happy': { label: 'ğŸ˜Š ê¸ì • (Positive)', category: 'positive', feedback: 'ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤! ì§€ê¸ˆì²˜ëŸ¼ ê¸ì •ì ì¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©° ì§‘ì¤‘í•˜ì„¸ìš”.', color: '#10B981' },
            'Surprise': { label: 'ğŸ˜Š ê¸ì • (Positive)', category: 'positive', feedback: 'ë†€ë¼ì›€ì€ ê¸ì •ì ì¸ í¥ë¯¸ì˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìŠµì— ì—´ì¤‘í•˜ê³  ê³„ì‹œêµ°ìš”!', color: '#10B981' },
            'Neutral': { label: 'ğŸ§˜ ì¤‘ë¦½ (Neutral)', category: 'neutral', feedback: 'í¸ì•ˆí•˜ê³  ì§‘ì¤‘ëœ ìƒíƒœì…ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœê°€ í•™ìŠµì— ê°€ì¥ íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', color: '#0EA5E9' },
            'Angry': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ì ì‹œ ë©ˆì¶”ê³  ì‹¬í˜¸í¡ì„ í•˜ê±°ë‚˜ 5ë¶„ê°„ íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”. (ì•Œë¦¼: ğŸ””ğŸš¨)', color: '#DC2626' },
            'Disgust': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! í™˜ê²½ì´ë‚˜ ë‚´ìš©ì— ëŒ€í•œ ë¶ˆë§Œì¡± ì‹ í˜¸ì…ë‹ˆë‹¤. ìë¦¬ë¥¼ ë°”ê¿”ë³´ì„¸ìš”.', color: '#DC2626' },
            'Fear': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', 'category': 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ë¶ˆì•ˆê°ì„ ëŠë¼ê³  ìˆìŠµë‹ˆë‹¤. ë„ˆë¬´ ì–´ë µë‹¤ë©´ ì‰¬ìš´ ë‚´ìš©ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ ë³´ì„¸ìš”.', color: '#DC2626' },
            'Sad': { label: 'ğŸ˜¥ ë¶€ì • (Negative)', category: 'negative', feedback: 'ë¶€ì •ì  ê°ì • ì‹ í˜¸! ì ì‹œ ì‰¬ì–´ê°€ëŠ” ì‹œê°„ì„ ê°–ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?', color: '#DC2626' }
        };

        // --- 3. í”¼ë“œë°± (ì§„ë™ & ìŒí–¥) ê¸°ëŠ¥ ---
        function playNegativeFeedback() {
            // A. ì§„ë™ í”¼ë“œë°± (ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œë§Œ ì‘ë™)
            if (navigator.vibrate) {
                // ì§§ê²Œ 3ë²ˆ ì§„ë™ (100ms on, 50ms off)
                navigator.vibrate([100, 50, 100, 50, 100]);
            }
            
            // B. ìŒí–¥ í”¼ë“œë°± (Web Audio API - ìˆœìˆ˜ JavaScriptë¡œ ìƒì„±)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine'; // ì‚¬ì¸íŒŒ (ë¶€ë“œëŸ¬ìš´ ì†Œë¦¬)
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // 440 Hz (ë¼ ìŒ)
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime); // ë³¼ë¥¨ 50%
            
            oscillator.start();
            
            // 0.3ì´ˆ í›„ì— ì†Œë¦¬ ë„ê¸°
            setTimeout(() => {
                oscillator.stop();
            }, 300);
        }

        // --- 4. ëª¨ë¸ ë¡œë“œ ---
        async function loadModel() {
            statusElement.textContent = "ëª¨ë¸ ë¡œë”© ì¤‘: tfjs_model/model.json";
            try {
                model = await tf.loadLayersModel('tfjs_model/model.json');
                statusElement.textContent = "âœ… ëª¨ë¸ ë¡œë“œ ì„±ê³µ! ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ ì£¼ì„¸ìš”.";
                statusElement.classList.remove('bg-blue-100');
                statusElement.classList.add('bg-green-100', 'text-green-700');
            } catch (error) {
                console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
                statusElement.textContent = "âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. 'tfjs_model' í´ë”ì™€ model.json ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                statusElement.classList.remove('bg-blue-100');
                statusElement.classList.add('bg-red-100', 'text-red-700');
            }
        }

        // --- 5. ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘/ì¤‘ì§€ í† ê¸€ ---
        function toggleCameraStream() {
            if (isCameraActive) {
                stopStream();
            } else {
                const url = cameraUrlInput.value.trim();
                if (url) {
                    startStreamFromUrl(url); // IP ì¹´ë©”ë¼ URL ì‚¬ìš©
                } else {
                    startInternalWebcam(); // ë‚´ì¥ ì¹´ë©”ë¼ ì‚¬ìš©
                }
            }
        }
        
        function stopStream() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            } else if (video.src) {
                video.src = ''; // IP ì¹´ë©”ë¼ ì´ë¯¸ì§€ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            }
            isCameraActive = false;
            startStopBtn.textContent = "ì¹´ë©”ë¼ ì‹œì‘";
            startStopBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            startStopBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            videoWrapper.classList.remove('camera-active');
            videoWrapper.classList.add('camera-inactive');
            categoryPredictionElement.className = 'text-3xl font-extrabold mb-3 text-center transition-colors duration-500 rounded-lg p-3 unknown';
            categoryPredictionElement.textContent = "ì¹´ë©”ë¼ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.";
            feedbackElement.textContent = "ì¹´ë©”ë¼ë¥¼ ë‹¤ì‹œ ì‹œì‘í•´ ì£¼ì„¸ìš”.";
        }
        
        // ë‚´ì¥ ì›¹ìº  ì‹œì‘ ë¡œì§
        function startInternalWebcam() {
            statusElement.textContent = "ë‚´ì¥ ì›¹ìº  ì ‘ê·¼ ìš”ì²­ ì¤‘...";
            navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
                .then(stream => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        overlayCanvas.width = video.videoWidth;
                        overlayCanvas.height = video.videoHeight;
                        isCameraActive = true;
                        startStopBtn.textContent = "ì¹´ë©”ë¼ ì¤‘ì§€";
                        startStopBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        startStopBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        videoWrapper.classList.add('camera-active');
                        videoWrapper.classList.remove('camera-inactive');
                        statusElement.textContent = "âœ… ë‚´ì¥ ì›¹ìº  ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘.";
                        runDetection();
                    };
                })
                .catch(err => {
                    console.error("ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:", err);
                    statusElement.textContent = "âŒ ì›¹ìº  ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•˜ê±°ë‚˜, ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                });
        }
        
        // IP ì¹´ë©”ë¼ URL ì‹œì‘ ë¡œì§ (Warning: CORS/HTTPS ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)
        function startStreamFromUrl(url) {
            statusElement.textContent = `IP ì¹´ë©”ë¼ URL (${url})ë¡œ ì‹œë„ ì¤‘... (CORS ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)`;
            video.srcObject = null;
            video.src = url;
            video.onloadedmetadata = () => {
                video.play();
                overlayCanvas.width = video.videoWidth || 640;
                overlayCanvas.height = video.videoHeight || 480;
                isCameraActive = true;
                startStopBtn.textContent = "ì¹´ë©”ë¼ ì¤‘ì§€";
                startStopBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                startStopBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                videoWrapper.classList.add('camera-active');
                videoWrapper.classList.remove('camera-inactive');
                statusElement.textContent = "âœ… IP ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì‹œë„.";
                runDetection();
            };
            video.onerror = () => {
                statusElement.textContent = `âŒ URL ë¡œë“œ ì‹¤íŒ¨: ${url}. ë³´ì•ˆ/CORS/ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                stopStream();
            };
        }

        // --- 6. ì‹¤ì‹œê°„ ê°ì • ì¸ì‹ ë£¨í”„ ---
        async function runDetection() {
            if (video.paused || video.ended || !model || !isCameraActive) {
                return;
            }

            // FPS ê³„ì‚°
            const currentTime = performance.now();
            const elapsed = currentTime - lastTime;
            const fps = (1000 / elapsed).toFixed(1);
            lastTime = currentTime;
            fpsElement.textContent = `FPS: ${fps}`;

            // ìº”ë²„ìŠ¤ì— ì›¹ìº  í”„ë ˆì„ ê·¸ë¦¬ê¸°
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            ctx.drawImage(video, 0, 0, overlayCanvas.width, overlayCanvas.height);

            tf.tidy(() => {
                // 1. ì´ë¯¸ì§€ ì „ì²˜ë¦¬: 48x48 í‘ë°±, ì •ê·œí™”
                const tensor = tf.browser.fromPixels(overlayCanvas)
                    .mean(2)
                    .expandDims(2)
                    .resizeBilinear([48, 48])
                    .expandDims(0)
                    .div(255.0);
                
                // 2. ì˜ˆì¸¡
                const predictions = model.predict(tensor);
                
                // 3. ê²°ê³¼ í•´ì„ (7-í´ë˜ìŠ¤)
                const scores = predictions.dataSync();
                const predictedClass = predictions.argMax(-1).dataSync()[0];
                const maxConfidence = scores[predictedClass];
                const emotionName7 = EMOTIONS_7_CLASS[predictedClass];

                let currentCategory, result;

                if (maxConfidence < CONFIDENCE_THRESHOLD) {
                    // 4. [ì¤‘ìš” ìˆ˜ì •] ì‹ ë¢°ë„ê°€ ë‚®ìœ¼ë©´ Unknownìœ¼ë¡œ ë¶„ë¥˜ (ì„ì˜ ë¶„ë¥˜ ë°©ì§€)
                    currentCategory = 'Unknown';
                    result = { 
                        label: 'ğŸ¤” ê°ì • ë¯¸í™•ì¸ (Unknown)', 
                        category: 'unknown', 
                        feedback: 'ì‹ ë¢°ë„ê°€ ë‚®ê±°ë‚˜ ì–¼êµ´ì´ ëª…í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìì„¸ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”.', 
                        color: '#6B7280' 
                    };
                } else {
                    // 4-1. 3-ì¹´í…Œê³ ë¦¬ ë§¤í•‘ ë° í”¼ë“œë°± ì¶”ì¶œ
                    result = CATEGORY_MAP[emotionName7];
                    currentCategory = result.category;
                }

                // 5. í”¼ë“œë°± ë° ì•Œë¦¼ (ìƒíƒœ ë³€í™” ì‹œ)
                if (currentCategory === 'negative' && lastCategory !== 'negative') {
                    // ë¶€ì •ì  ìƒíƒœë¡œ ì „í™˜ ì‹œì—ë§Œ ì•Œë¦¼
                    playNegativeFeedback();
                }
                lastCategory = currentCategory;

                // 6. UI ì—…ë°ì´íŠ¸
                categoryPredictionElement.className = 'text-3xl font-extrabold mb-3 text-center transition-colors duration-500 rounded-lg p-3';
                categoryPredictionElement.classList.add(result.category);
                categoryPredictionElement.textContent = result.label;
                
                feedbackElement.textContent = result.feedback;
                confidenceElement.textContent = `ì‹ ë¢°ë„: ${(maxConfidence * 100).toFixed(2)}% (ì›ë³¸: ${emotionName7})`;
                
                // 7. ì‹œê°í™”
                drawPredictionBox(result.color, emotionName7);
            });

            animationFrameId = requestAnimationFrame(runDetection);
        }

        // --- 7. ì˜ˆì¸¡ ê²°ê³¼ ì‹œê°í™” ---
        function drawPredictionBox(color, emotionName7) {
            const size = Math.min(overlayCanvas.width, overlayCanvas.height) * 0.5;
            const x = (overlayCanvas.width - size) / 2;
            const y = (overlayCanvas.height - size) / 2;

            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.strokeRect(x, y, size, size);

            ctx.fillStyle = color;
            ctx.fillRect(x, y - 35, size, 35);

            ctx.fillStyle = 'white';
            ctx.font = '22px Inter';
            ctx.fillText(emotionName7, x + 5, y - 12);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™” ---
        startStopBtn.addEventListener('click', toggleCameraStream);
        window.onload = loadModel;
    </script>
</body>
</html>